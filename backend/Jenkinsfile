pipeline {
    agent any

    triggers {
        githubPush()
    }


    environment {
        // Flask + Mastodon environment variables
        MASTODON_API_URL = 'https://mastodon.social'          // Change to your instance
        MASTODON_ACCESS_TOKEN = credentials('mastodon-token')     // Use Jenkins Credentials!
        FLASK_ENV = 'development'
        HOST = '0.0.0.0'
        PORT = '5050'
        DEBUG = 'False'
    }

    stages {
        stage('Clone Repository') {
            steps {
                // Use credentials stored in Jenkins for GitHub access
                withCredentials([usernamePassword(credentialsId: 'github-creds', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')]) {
                    // Clone the repository using the provided GitHub credentials
                    sh 'git clone https://${GIT_USER}:${GIT_TOKEN}@github.com/yourusername/yourrepository.git'
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'pip install -r requirements.txt'
            }
        }

        stage('Run Linting or Tests') {
            steps {
                // Replace this with pytest or any validation/linting you want
                sh 'python -m py_compile app.py'
            }
        }

        stage('Run Flask App') {
            steps {
                sh 'python app.py & sleep 5'  // Run in background for testing (or skip this in CI)
                sh 'curl http://localhost:${PORT} || true'  // Test if it's running (optional)
            }
        }
    }

    post {
        success {
            echo '✅ Python Flask app build succeeded!'
        }
        failure {
            echo '❌ Build failed.'
        }
    }
}
